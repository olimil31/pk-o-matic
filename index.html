<!doctype html>
<title>PK-O-Matic</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --bg:#fff; --fg:#000; }
  @media (prefers-color-scheme:dark){ :root { --bg:#000; --fg:#fff; } }
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui;display:flex;flex-direction:column;height:100vh;align-items:center;justify-content:center}
  #pk{font-size:12vw;font-weight:700}
  #warn{font-size:3vw;color:crimson;margin:.5em 0}
  #speed{font-size:5vw}
  #debug{position:fixed;bottom:0;left:0;width:100%;background:#0008;color:lime;font-size:3vw;padding:2px}
</style>

<div id="pk">--</div>
<div id="warn">PK non garanti / usage indicatif</div>
<div id="speed">-- km/h</div>
<div id="debug">Chargementâ€¦</div>

<script>
// simple test
document.getElementById('debug').textContent = 'JS OK';

navigator.geolocation.watchPosition(
  pos => {
    const { latitude, longitude, speed } = pos.coords;
    document.getElementById('debug').textContent = `GPS: ${latitude}, ${longitude}`;
    // approximation rapide : on prend la ligne la plus proche (voir plus tard la margin box)
fetch('/data/pks/index.json')
  .then(r => r.json())
  .then(index => {
    let bestLine = null;
    let bestDist = 1e9;
    for (const [l, b] of Object.entries(index)) {
      const d = Math.abs(latitude - (b.minLat + b.maxLat) / 2) +
                Math.abs(longitude - (b.minLon + b.maxLon) / 2);
      if (d < bestDist) { bestDist = d; bestLine = l; }
    }
    if (bestLine) {
      fetch(`/data/pks/${bestLine}.json`)
        .then(r => r.json())
        .then(pts => {
          // approximation : PK le plus proche
          let bestPK = pts[0].pk;
          let bestD2 = 1e9;
          for (const p of pts) {
            const d2 = Math.abs(latitude - p.lat) + Math.abs(longitude - p.lon);
            if (d2 < bestD2) { bestD2 = d2; bestPK = p.pk; }
          }
          document.getElementById('pk').textContent = `${bestLine} PK ${bestPK}`;
        });
    } else {
      document.getElementById('pk').textContent = 'Hors ligne SNCF';
    }
  });

    document.getElementById('speed').textContent = speed ? `${(speed*3.6).toFixed(0)} km/h` : '';
  },
  err => { document.getElementById('debug').textContent = 'GPS ERR: ' + err.message; },
  { enableHighAccuracy: true, maximumAge: 5000 }
);
</script>

